name: Release workflow trigger

on:
  issue_comment:
    types: [created]

jobs:
  release:
    if: |
      !github.event.issue.pull_request && 
      startsWith(github.event.issue.title, 'ğŸ¤ [Release]') &&
      startsWith(github.event.comment.body, '/start') &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Version and post comment
        env:
          GH_TOKEN: ${{ github.token }}
        id: parse_version
        run: |
          RAW_VERSION=$(echo "${{ github.event.comment.body }}" | awk '{print $2}')
          if [ -z "$RAW_VERSION" ]; then
            echo "VERSION_MISSING=true" >> $GITHUB_ENV
            exit 1
          fi
          STRIPPED_VERSION=$(echo $RAW_VERSION | sed 's/^v//')
          echo "RAW_VERSION=$RAW_VERSION" >> $GITHUB_ENV
          echo "STRIPPED_VERSION=$STRIPPED_VERSION" >> $GITHUB_ENV

          gh issue comment ${{ github.event.issue.number }} --body "ğŸš€ **ë¦´ë¦¬ì¦ˆ ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ($RAW_VERSION)**"

      - name: Git Config Setup
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Process Release and Direct Merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RAW_VER=${{ env.RAW_VERSION }}
          STRIP_VER=${{ env.STRIPPED_VERSION }}
          RELEASE_BRANCH="release/$RAW_VER"
          XCODE_PROJ_PATH="QueenCam/QueenCam.xcodeproj/project.pbxproj"

          # 1. developì—ì„œ ì‹œì‘í•˜ì—¬ ë¦´ë¦¬ì¦ˆ ë¸Œëœì¹˜ ìƒì„±
          git checkout develop
          git checkout -b $RELEASE_BRANCH

          # 2. Marketing Version ë° Build Number ì—…ë°ì´íŠ¸
          sed -i "s/MARKETING_VERSION = .*/MARKETING_VERSION = $STRIP_VER;/g" $XCODE_PROJ_PATH
          
          OLD_BUILD_NUMBER=$(grep -m 1 "CURRENT_PROJECT_VERSION =" $XCODE_PROJ_PATH | sed -E 's/.*=[[:space:]]*([0-9]+);/\1/')
          NEW_BUILD_NUMBER=$((OLD_BUILD_NUMBER + 1))
          sed -i "s/CURRENT_PROJECT_VERSION = .*/CURRENT_PROJECT_VERSION = $NEW_BUILD_NUMBER;/g" $XCODE_PROJ_PATH
          
          git add .
          git commit -m "[Chore] release: v$STRIP_VER ë¹Œë“œ ë„˜ë²„ ì¦ê°€ ($NEW_BUILD_NUMBER)"

          # 3. CHANGELOG.md ì—…ë°ì´íŠ¸
          TODAY=$(date +'%Y-%m-%d')
          sed -i "s/## \[Unreleased\]/## [$RAW_VER] - $TODAY/g" CHANGELOG.md
          git add CHANGELOG.md
          git commit -m "[Docs] release: $RAW_VER CHANGELOG.md"

          # 4. ğŸ”¥ ë¦´ë¦¬ì¦ˆ ë¸Œëœì¹˜ë¥¼ ë¦¬ëª¨íŠ¸ì— í‘¸ì‹œ
          git push origin $RELEASE_BRANCH

          # --- ì§ì ‘ ë³‘í•© ë° íƒœê¹… ---

          # 5. main ë¸Œëœì¹˜ì— ë³‘í•© ë° íƒœê·¸ ìƒì„±
          git checkout main
          git merge --no-ff $RELEASE_BRANCH -m "Merge release branch $RELEASE_BRANCH into main"
          git tag -a "$RAW_VER" -m "Release $RAW_VER"

          # 6. develop ë¸Œëœì¹˜ì— ë°±ë¨¸ì§€
          git checkout develop
          git merge --no-ff $RELEASE_BRANCH -m "Merge release branch $RELEASE_BRANCH back to develop"

          # 7. main, develop ë¸Œëœì¹˜ì™€ íƒœê·¸ í‘¸ì‹œ
          git push origin main develop --tags

          # 8. ë¡œì»¬ ì‘ì—…ìš© ë¸Œëœì¹˜ ì‚­ì œ
          git branch -d $RELEASE_BRANCH

      - name: Post Success Comment
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RAW_VERSION=${{ env.RAW_VERSION }}
          gh issue comment ${{ github.event.issue.number }} --body "ğŸš€ **ë¦´ë¦¬ì¦ˆ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ($RAW_VERSION)**"
