name: Release workflow trigger

on:
  issue_comment:
    types: [created]

jobs:
  release:
    if: |
      !github.event.issue.pull_request && 
      startsWith(github.event.issue.title, 'ğŸ¤ [Release]') &&
      startsWith(github.event.comment.body, '/start') &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Version
        id: parse_version
        run: |
          VERSION=$(echo "${{ github.event.comment.body }}" | awk '{print $2}')
          if [ -z "$VERSION" ]; then
            echo "VERSION_MISSING=true" >> $GITHUB_ENV
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Git Config Setup
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Process Release and Direct Merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${{ env.VERSION }}
          RELEASE_BRANCH="release/$VERSION"

          # 1. developì—ì„œ ì‹œì‘í•˜ì—¬ ë¦´ë¦¬ì¦ˆ ë¸Œëœì¹˜ ìƒì„±
          git checkout develop
          git checkout -b $RELEASE_BRANCH

          # 2. ë¹Œë“œ ë„˜ë²„ ì¦ê°€ (+1)
          OLD_BUILD_NUMBER=$(grep -m 1 "CURRENT_PROJECT_VERSION =" QueenCam/QueenCam.xcodeproj/project.pbxproj | sed -E 's/.*=[[:space:]]*([0-9]+);/\1/')
          NEW_BUILD_NUMBER=$((OLD_BUILD_NUMBER + 1))
          sed -i "s/CURRENT_PROJECT_VERSION = .*/CURRENT_PROJECT_VERSION = $NEW_BUILD_NUMBER;/g" QueenCam/QueenCam.xcodeproj/project.pbxproj
          
          git add .
          git commit -m "[Chore] release: ë¹Œë“œ ë„˜ë²„ ì¦ê°€ ($NEW_BUILD_NUMBER)"

          # 3. CHANGELOG.md ì—…ë°ì´íŠ¸
          TODAY=$(date +'%Y-%m-%d')
          sed -i "s/## \[Unreleased\]/## [$VERSION] - $TODAY/g" CHANGELOG.md
          
          git add CHANGELOG.md
          git commit -m "[Docs] release: $VERSION CHANGELOG.md"

          # --- ì§ì ‘ ë³‘í•© ì‹œì‘ ---

          # 4. main ë¸Œëœì¹˜ì— ë³‘í•© ë° íƒœê·¸ ìƒì„±
          git checkout main
          git merge --no-ff $RELEASE_BRANCH -m "Merge release branch $RELEASE_BRANCH into main"
          git tag -a "$VERSION" -m "Release $VERSION"

          # 5. develop ë¸Œëœì¹˜ì— ë°±ë¨¸ì§€ (ë¹Œë“œ ë„˜ë²„/ë¡œê·¸ ë°˜ì˜)
          git checkout develop
          git merge --no-ff $RELEASE_BRANCH -m "Merge release branch $RELEASE_BRANCH back to develop"

          # 6. ëª¨ë“  ë³€ê²½ì‚¬í•­ í•œ ë²ˆì— í‘¸ì‹œ
          # main, develop ë¸Œëœì¹˜ì™€ ìƒì„±ëœ íƒœê·¸ë¥¼ ëª¨ë‘ í‘¸ì‹œí•©ë‹ˆë‹¤.
          git push origin main develop --tags

      - name: Post Success Comment
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ğŸš€ **ë°°í¬ ì¤€ë¹„ ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**
          
          - **ë²„ì „:** \`${{ env.VERSION }}\`
          - **íƒœê·¸ ìƒì„±:** \`${{ env.VERSION }}\` íƒœê·¸ê°€ í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤.
          
          ì´ì œ Xcodeì—ì„œ í•´ë‹¹ íƒœê·¸ í˜¹ì€ main ë¸Œëœì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì•„ì¹´ì´ë¹™ ë° ë°°í¬ë¥¼ ì§„í–‰í•´ ì£¼ì„¸ìš”."

      - name: Post Failure Comment
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          MSG="âŒ ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¸Œëœì¹˜ ì¶©ëŒì´ë‚˜ ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”."
          gh issue comment ${{ github.event.issue.number }} --body "$MSG"
